<!DOCTYPE html>
<html lang="th">
@include('themes.head')


<body class="hold-transition layout-fixed">
    <div class="wrapper">
        <!-- Navbar -->
        @include('themes.er.navbarer')
        <!-- Main Sidebar Container -->
        @include('themes.ipd.menuipd')

        <div class="content-wrapper">
            <div class="container-fluid">

                <!-- Filter Form -->

                <div class="container py-4">
                    <h2 class="text mb-4">บันทึกวินิจฉัยผู้ป่วย Admit</h2>

                    @if($previousDiagnoses->count())
                    <div class="card mb-4">
                        <div class="card-header bg-info text-white">ประวัติ Admit สำหรับเคสนี้</div>
                        <div class="card-body">
                            @foreach($previousDiagnoses as $diag)
                            <p>
                                <strong>วันที่เข้าAdmit:</strong>
                                {{ \Carbon\Carbon::parse($diag->diagnosis_date)->format('d/m/Y') }}<br>
                                <strong>เวลา:</strong> {{ \Carbon\Carbon::parse($diag->diagnosis_date)->format('H:i') }}
                                น.<br>
                                <strong>แพทย์:</strong> {{ $diag->doctor_name }}<br>
                                <strong>โรคที่ได้รับการวินิจฉัย:</strong>
                            <ul>
                                @foreach($diag->diseases as $disease)
                                {{ $disease->icd10_code }} — {{ $disease->disease_name_en }}<br>
                                @endforeach
                            </ul>
                            <strong>สถานะ:</strong> {{ $diag->treatment_status }}<br>
                            <strong>หมายเหตุ:</strong> {{ $diag->notes }}
                            </p>
                            <hr>
                            @endforeach
                        </div>
                    </div>
                    @endif

                    <form id="diagnosisForm" action="{{ route('ipd.storeDiagnosis', $treatmentId) }}" method="POST">
                        @csrf

                        <input type="hidden" name="treatment_id" value="{{ $treatmentId }}">
                        <div class="card mb-4">
                            <div class="card-header bg-secondary text-white">ข้อมูลทหาร</div>
                            <div class="card-body">
                                <p><strong>ชื่อ:</strong> {{ $soldierName }}</p>
                                <p><strong>ผลัด:</strong> {{ $soldierRotation }}</p>
                                <p><strong>หน่วยฝึก:</strong> {{ $soldierTraining }}</p>
                                <p><strong>หน่วยต้นสังกัด:</strong> {{ $soldierUnit }}</p>
                            </div>
                        </div>
                        <div class="card shadow-sm p-4">

                            <div class="mb-3">
                                <label for="doctor_name" class="form-label">ชื่อแพทย์</label>
                                <input type="text" class="form-control" id="doctor_name" name="doctor_name"
                                    value="{{ old('doctor_name', $latestDiagnosis->doctor_name ?? '') }}" required>
                            </div>

                            <div class="row mb-3">
                                <div class="col">
                                    <label for="temperature" class="form-label">อุณหภูมิ (°C)</label>
                                    <input type="number" step="0.1" class="form-control" id="temperature"
                                        name="temperature"
                                        value="{{ old('temperature', $vitalSigns->temperature ?? '') }}">
                                </div>
                                <div class="col">
                                    <label for="blood_pressure" class="form-label">ความดันโลหิต</label>
                                    <input type="text" class="form-control" id="blood_pressure" name="blood_pressure"
                                        value="{{ old('blood_pressure', $vitalSigns->blood_pressure ?? '') }}">
                                </div>
                                <div class="col">
                                    <label for="heart_rate" class="form-label">ชีพจร</label>
                                    <input type="number" class="form-control" id="heart_rate" name="heart_rate"
                                        value="{{ old('heart_rate', $vitalSigns->heart_rate ?? '') }}">
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="icd10_code" class="form-label">รหัสโรค (ICD10)</label>
                                <input type="text" class="form-control" id="icd10_code" name="icd10_code"
                                    value="{{ old('icd10_code', implode(', ', $latestDiagnosis->diseases->pluck('icd10_code')->toArray() ?? [])) }}"
                                    required>
                            </div>

                            <div class="mb-3">
                                <label for="disease_name" class="form-label">คำอธิบายโรค</label>
                                <input type="text" class="form-control" id="disease_name" name="disease_name" readonly>
                            </div>

                            <div class="mb-3">
                                <label for="notes" class="form-label">หมายเหตุเพิ่มเติม</label>
                                <textarea class="form-control" id="notes" name="notes"
                                    rows="3">{{ old('notes', $latestDiagnosis->notes ?? '') }}</textarea>
                            </div>

                            <div class="mb-3">
                                <label for="treatment_status" class="form-label">สถานะการรักษา</label>
                                <select class="form-select" id="treatment_status" name="treatment_status" required>
                                    <option value="Admit" {{ old('treatment_status', $latestDiagnosis->treatment_status
                                        ?? '') == 'Admit' ? 'selected' : '' }}>Admit</option>
                                    <option value="Discharge" {{ old('treatment_status', $latestDiagnosis->
                                        treatment_status ?? '') == 'Discharge' ? 'selected' : '' }}>
                                        Discharge</option>
                                    <option value="Refer" {{ old('treatment_status', $latestDiagnosis->treatment_status
                                        ?? '') == 'Refer' ? 'selected' : '' }}>Refer</option>
                                    <option value="Follow-up" {{ old('treatment_status', $latestDiagnosis->
                                        treatment_status ?? '') == 'Follow-up' ? 'selected' : '' }}>
                                        Follow-up</option>
                                </select>
                            </div>

                            <!-- ✅ กรอบนัดหมายติดตาม -->
                            <div id="follow_up_fields" class="bg-light border rounded p-3 mb-3" style="display: none;">
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="appointment_date">วัน-เวลานัดหมายติดตาม</label>
                                        <input type="datetime-local" name="appointment_date" id="appointment_date"
                                            class="form-control">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="appointment_location">สถานที่นัดหมาย</label>
                                        <select name="appointment_location" id="appointment_location"
                                            class="form-select">
                                            <option value="OPD">OPD</option>
                                            <option value="ER">ER</option>
                                            <option value="IPD">IPD</option>
                                            <option value="กองพันทหารราบ">กองพันทหารราบ</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="case_type">ประเภทผู้ป่วย</label>
                                        <select name="case_type" id="case_type" class="form-select">
                                            <option value="normal">ปกติ</option>
                                            <option value="critical">วิกฤติ</option>
                                        </select>
                                    </div>
                                </div>
                            </div>


                            <!-- ✅ กรอบคำสั่งฝึก -->
                            <div id="training_instruction_container" class="bg-light border rounded p-3 mb-3"
                                style="display: none;">
                                <label for="training_instruction_option">คำสั่งฝึก:</label>
                                <select class="form-select rounded-pill mb-2" id="training_instruction_option">
                                    <option value="">-- เลือกคำสั่งฝึก --</option>
                                    <option value="normal">ฝึกได้ปกติ</option>
                                    <option value="skip">งดฝึก</option>
                                </select>
                                <div id="trainingDayDiv" style="display: none;">
                                    <label for="training_day_count">จำนวนวันที่งดฝึก (วัน):</label>
                                    <input type="number" id="training_day_count" class="form-control rounded-pill"
                                        min="1" placeholder="เช่น 5">
                                </div>
                                <input type="hidden" name="training_instruction" id="training_instruction">
                            </div>

                            <div class="d-flex justify-content-end pe-0 mt-4">
                                <button type="submit" class="btn btn-success">บันทึกวินิจฉัยใหม่</button>
                            </div>

                        </div>


                    </form>
                    <!-- Display Total Stats -->



                </div>
            </div>
        </div>
    </div>

    @include('themes.script')
</body>


<script>
    document.getElementById('icd10_code').addEventListener('input', function () {
        const value = this.value;
        if (value.trim() !== '') {
            fetchDiseaseInfo(value);
        } else {
            document.getElementById('disease_name').value = '';
        }
    });

    async function fetchDiseaseInfo(codes) {
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        const codeArray = codes.split(',');
        const diseaseDescriptions = await Promise.all(codeArray.map(async code => {
            const res = await fetch(`/diseases/ipd/${code.trim()}`, {
                headers: { 'X-CSRF-TOKEN': csrfToken }
            });
            if (res.ok) {
                const data = await res.json();
                return data.diseases?.[0]?.disease_name ?? `ไม่พบข้อมูล: ${code}`;
            }
            return `ไม่พบข้อมูล: ${code}`;
        }));

        document.getElementById('disease_name').value = diseaseDescriptions.join(', ');
    }
    const treatmentStatusSelect = document.getElementById('treatment_status');
    const trainingInstructionField = document.getElementById('training_instruction_container');
    const followUpFields = document.getElementById('follow_up_fields');

    function toggleConditionalFields() {
        const selected = treatmentStatusSelect.value;

        trainingInstructionField.style.display = (selected === 'Discharge' || selected === 'Follow-up') ? 'block' : 'none';
        followUpFields.style.display = (selected === 'Follow-up') ? 'block' : 'none';
    }

    treatmentStatusSelect.addEventListener('change', toggleConditionalFields);
    document.addEventListener('DOMContentLoaded', toggleConditionalFields);
    document.getElementById('training_instruction_option').addEventListener('change', function () {
        const selected = this.value;
        const trainingDayDiv = document.getElementById('trainingDayDiv');
        const hiddenInput = document.getElementById('training_instruction');

        if (selected === 'normal') {
            trainingDayDiv.style.display = 'none';
            hiddenInput.value = 'ฝึกได้ปกติ';
        } else if (selected === 'skip') {
            trainingDayDiv.style.display = 'block';
            hiddenInput.value = ''; // รอ user กรอกวันแล้วค่อยอัปเดต
        } else {
            trainingDayDiv.style.display = 'none';
            hiddenInput.value = '';
        }
    });

    // อัปเดตค่าจริงเมื่อ user กรอกจำนวนวัน
    document.getElementById('training_day_count').addEventListener('input', function () {
        const day = this.value;
        const hiddenInput = document.getElementById('training_instruction');
        if (day) {
            hiddenInput.value = `งดฝึก(${day} วัน)`;
        } else {
            hiddenInput.value = '';
        }
    });
</script>

</html>




<style>
    .custom-dropdown {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-color: rgb(255, 255, 255);
        border: 1px solid #d1d5db;
        padding: 10px 14px;
        font-size: 1rem;
        border-radius: 6px;
        width: 20%;
        font-family: 'Segoe UI', sans-serif;
        background-image: url("data:image/svg+xml;utf8,<svg fill='navy' height='24' viewBox='0 0 24 24' width='24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>");
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 20px;
    }

    .form-select {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-color: rgb(255, 255, 255);
        border: 1px solid #d1d5db;
        padding: 10px 14px;
        font-size: 1rem;
        border-radius: 6px;
        width: 100%;
        font-family: 'Segoe UI', sans-serif;
        background-image: url("data:image/svg+xml;utf8,<svg fill='navy' height='24' viewBox='0 0 24 24' width='24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>");
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 20px;
    }
</style>